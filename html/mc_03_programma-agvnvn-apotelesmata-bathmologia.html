<!doctype html>
<html lang="el">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <meta name="description" content="MatchCenter - Πρόγραμμα, αποτελέσματα αγώνων και βαθμολογίες" />
    <meta name="keywords" content="MatchCenter, basketball, games, results, ranking, rosters, players, champions, μπάσκετ, πρωτάθλημα, διοργάνωση, πρόγραμμα, βαθμολογία" />
    <meta name="language" content="greek" />
    <meta name="author" content="MatchCenter" />
    <meta name="web_author" content="Lazaros T" />
    <link rel="icon" href="../favicon.ico" />


    <title>MatchCenter | Πρόγραμμα, αποτελέσματα αγώνων και βαθμολογίες</title>

    <!-- Google Fonts: Krona One for titles, Inter for body text -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Krona+One&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700&display=swap" rel="stylesheet" />

    <!-- Bootstrap 5 CSS and JS Bundle -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    
    <!-- Google Charts Library for data visualization -->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>


    <script type="text/javascript">
        // Ensure Google Charts is loaded and ready before calling drawchart
        // Changed packages to an empty object as specific chart types are not directly used for drawing
        google.charts.load('current', {}); 
        google.charts.setOnLoadCallback(drawchart);

        // --- Global variables for default values (can be overridden by URL parameters) ---
        var defaultNameDiorganvtriaArxh = "ΕΚΑΣΘ";
        var defaultPowerDiorganvtriaArxh = "1bURffybc07Eel69CZu1WKpGj_DIRA8gaE6rQUBtg5WI";
        var defaultAgvnistikhPeriodos = "2025-26";
        var defaultNamePrvtathlhmatos = "ΕΚΑΣΘ 2025-2026";
        var defaultPowerPrvtathlhmatos = "12ZPDSn9GLS29gAGrDsAyZ1Gz6yObTKCeD0yZVFU-IVk";
        var defaultNameKathgoriasOmilou = "Α1 Ανδρών";
        var defaultPowerKathgoriasOmilou = "1S-42x8-L-uJ8c7_1G52GgP22L-9c7F0x1D23Xf45A6B"; // Default Sheet ID for Program/Standings
        // Default logo URL if no logo is provided in the spreadsheet
        const DEFAULT_LOGO_URL = "https://lh3.googleusercontent.com/-_r1FEKyvfIA/V5o9rF6kKLI/AAAAAAABNFE/p_lq6O0AKQ8CNJJRJ0jotUb4jGsUthdqgCCo/s36/white-repo-circle.png";

        // Global variables for filter data and current date range
        let uniqueRounds = [];
        let sortedUniqueTeams = [];
        let gamesByRound = {}; // Make gamesByRound globally accessible
        let standingsByRound = {}; // Make standingsByRound globally accessible - FIX for ReferenceError
        let today = new Date();
        today.setHours(0, 0, 0, 0); // Normalize to start of day (midnight)
        const DAYS_OFFSET = 4; // +/- 4 days for the active round window
        let fourDaysBeforeToday = new Date(today);
        fourDaysBeforeToday.setDate(today.getDate() - DAYS_OFFSET);
        let fourDaysAfterToday = new Date(today);
        fourDaysAfterToday.setDate(today.getDate() + DAYS_OFFSET);
        let firstAccordionToOpen = null; // Store ID of the first accordion to be opened by default logic

        // New global variable to store external round parameter
        let externalRoundParam = null;


        /**
         * Parses URL query parameters.
         * Applies decodeURIComponent twice to handle potential double encoding.
         * @param {string} variable The name of the query parameter to retrieve.
         * @returns {string|boolean} The value of the parameter or false if not found.
         */
        function getQueryVariable(variable){
            var query = window.location.search.substring(1);
            var vars = query.split("&");
            for (var i=0; i<vars.length; i++) {
                var pair = vars[i].split("=");
                if(pair[0] === variable){
                    // Apply decodeURIComponent twice to handle potential double encoding
                    return decodeURIComponent(decodeURIComponent(pair[1]));
                }
            }
            return(false);
        }

        /**
         * Initializes the chart drawing and sets the header title based on URL parameters.
         * This function is called as the callback for google.load to ensure Google Charts API is ready.
         */
        function drawchart(){
            // Retrieve parameters from URL, using defaults if not present, and ensure double decoding
            var pNameDiorganvtriaArxh = getQueryVariable("pNameDiorganvtriaArxh") ? getQueryVariable("pNameDiorganvtriaArxh") : defaultNameDiorganvtriaArxh;
            var pAgvnistikhPeriodos = getQueryVariable("pAgvnistikhPeriodos") ? getQueryVariable("pAgvnistikhPeriodos") : defaultAgvnistikhPeriodos;
            var pNameKathgoriasOmilou = getQueryVariable("pNameKathgoriasOmilou") ? getQueryVariable("pNameKathgoriasOmilou") : defaultNameKathgoriasOmilou;
            
            // Retrieve pAgvnistikh if present and validate it
            var pAgvnistikh = getQueryVariable("pAgvnistikh"); // Reverted to pAgvnistikh
            if (pAgvnistikh) {
                const parsedAgvnistikh = parseInt(pAgvnistikh);
                if (!isNaN(parsedAgvnistikh) && parsedAgvnistikh > 0) { // Ensure it's a positive number
                    externalRoundParam = String(parsedAgvnistikh); // Store as string to match roundNumber format
                }
            }

            // Update the combined header title
            document.getElementById("combined-header-title").innerHTML = `ΠΡΟΓΡΑΜΜΑ & ΒΑΘΜΟΛΟΓΙΕΣ | ${pNameKathgoriasOmilou} (${pAgvnistikhPeriodos}) | ${pNameDiorganvtriaArxh}`;
            
            drawGamesAndStandings();
        }

        /**
         * Fetches game and standings data from the Google Sheet using Google Visualization API.
         * It uses the pPowerKathgoriasOmilou parameter (Sheet ID) to query the specific sheet.
         */
        function drawGamesAndStandings() {
            var pPowerKathgoriasOmilou = getQueryVariable("pPowerKathgoriasOmilou") ? getQueryVariable("pPowerKathgoriasOmilou") : defaultPowerKathgoriasOmilou;

            // Query for all data.
            // Ordering will be handled in JavaScript after grouping for more flexibility.
            var strQueryForURI = 'select * ';
            var queryString = encodeURIComponent(strQueryForURI);

            // Fetch data from gid=6 as per the original file
            var query = new google.visualization.Query(
                'https://docs.google.com/spreadsheets/d/'+ pPowerKathgoriasOmilou +'/gviz/tq?gid=6&headers=1&tq=' + queryString);
            query.send(handle_DrawGamesAndStandings_DataQueryResponse);
        }

        // Array for short day names in Greek
        const dayNamesShort = ['Κυρ', 'Δευ', 'Τρι', 'Τετ', 'Πεμ', 'Παρ', 'Σαβ'];

        /**
         * Formats a Date object into "DDD, DD-MM-YYYY" string.
         * @param {Date} dateObj The Date object to format.
         * @returns {string} The formatted date string.
         */
        function formatFullDateWithDay(dateObj) {
            const dayName = dayNamesShort[dateObj.getDay()];
            const formattedDay = String(dateObj.getDate()).padStart(2, '0');
            const formattedMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
            const formattedYear = dateObj.getFullYear(); 

            return `${dayName}, ${formattedDay}-${formattedMonth}-${formattedYear}`;
        }

        /**
         * Formats a Date object into "DD-MM-YYYY" string.
         * @param {Date} dateObj The Date object to format.
         * @returns {string} The formatted date string.
         */
        function formatSimpleDate(dateObj) {
            const formattedDay = String(dateObj.getDate()).padStart(2, '0');
            const formattedMonth = String(dateObj.getMonth() + 1).padStart(2, '0');
            const formattedYear = dateObj.getFullYear();
            return `${formattedDay}-${formattedMonth}-${formattedYear}`;
        }

        /**
         * Handles the data response from the Google Sheet query and renders games and standings using nested accordions and tabs.
         * Data is grouped by "ΑΓΩΝΙΣΤΙΚΗ" (Column B). Each accordion item contains two tabs: "Αγώνες" and "Βαθμολογία".
         * @param {object} response The Google Visualization API query response.
         */
        function handle_DrawGamesAndStandings_DataQueryResponse(response) {
            // Get reference to the loading spinner
            var loadingSpinnerDiv = document.getElementById("loading-spinner");
            var contentDiv = document.getElementById("list-content-id");

            if (response.isError()) {
                console.error('Error in Google Charts query:', response.getMessage(), response.getDetailedMessage(), response);
                let errorMessage = 'Προέκυψε σφάλμα κατά τη φόρτωση δεδομένων. ';
                if (response.getMessage().includes('timed out')) {
                    errorMessage += 'Η αίτηση χρονόληξε. Παρακαλώ ελέγξτε τη σύνδεσή σας στο διαδίκτυο και δοκιμάστε ξανά.';
                } else {
                    errorMessage += 'Λεπτομέρειες: ' + response.getMessage() + '. Παρακαλώ δοκιμάστε ξανά αργότερα.';
                }
                
                contentDiv.innerHTML = `<div class="col-12"><p class="text-center text-danger">${errorMessage}</p></div>`;
                
                if (loadingSpinnerDiv) {
                    loadingSpinnerDiv.remove(); // Ensure spinner is removed on error
                }
                return;
            }

            var data = response.getDataTable();
            var totalRows = data.getNumberOfRows();
            
            if (loadingSpinnerDiv) {
                loadingSpinnerDiv.remove(); // Ensure spinner is removed on success
            }
            contentDiv.innerHTML = ''; // Clear existing content

            if (totalRows === 0) {
                contentDiv.innerHTML = '<div class="col-12"><p class="text-center text-muted">Δεν βρέθηκαν δεδομένα για το επιλεγμένο πρωτάθλημα/κατηγορία.</p></div>';
                return;
            }

            // Extract promotion/relegation values from BZ column (index 77)
            // Assuming BZ2 is row 1 (index 0) and BZ3 is row 2 (index 1) in Column BZ
            let promotionPositions = parseInt(data.getFormattedValue(0, 77)); // BZ2
            let relegationStartFrom = parseInt(data.getFormattedValue(1, 77)); // BZ3

            // Robust checks for NaN: If parsing fails, set to null
            if (isNaN(promotionPositions)) {
                promotionPositions = null;
            }
            if (isNaN(relegationStartFrom)) {
                relegationStartFrom = null;
            }

 //           console.log("Promotion Positions (BZ2):", promotionPositions);
 //           console.log("Relegation Start From (BZ3):", relegationStartFrom);

            // Clear previous data before populating
            gamesByRound = {}; 
            standingsByRound = {}; // Clear previous data for standingsByRound
            let allUniqueTeams = new Set();
            uniqueRounds = [];

            for (var row = 0; row < totalRows; row++) {
                var roundForGame = data.getFormattedValue(row, 1); // Column B: ΑΓΩΝΙΣΤΙΚΗ (for games)
                var roundForStanding = data.getFormattedValue(row, 29); // Column AD: ΑΓΩΝΙΣΤΙΚΗ (for standings)

                // Populate gamesByRound
                if (data.getFormattedValue(row, 16) !== "") { // Check if it's a game entry (Column Q is not empty)
                    if (!gamesByRound[roundForGame]) {
                        gamesByRound[roundForGame] = [];
                        if (!uniqueRounds.includes(roundForGame)) { 
                            uniqueRounds.push(roundForGame);
                        }
                    }
                    // Create an object for each game row
                    const gameData = {
                        round: roundForGame,
                        date: data.getFormattedValue(row, 3), // Column D
                        time: data.getFormattedValue(row, 4), // Column E
                        arena: data.getFormattedValue(row, 5), // Column F
                        teamA_name: data.getFormattedValue(row, 6), // Column G
                        teamB_name: data.getFormattedValue(row, 7), // Column H
                        scoreA: data.getFormattedValue(row, 8), // Column I
                        scoreB: data.getFormattedValue(row, 9), // Column J
                        gameCode: data.getFormattedValue(row, 16), // Column Q
                        teamA_logo: data.getFormattedValue(row, 53) || DEFAULT_LOGO_URL, // Column BB (index 53) or default
                        teamB_logo: data.getFormattedValue(row, 54) || DEFAULT_LOGO_URL,  // Column BC (index 54) or default
                        // Add officials' data with new indices as per user's specification
                        referee1: data.getFormattedValue(row, 10), // Column K (index 10)
                        referee2: data.getFormattedValue(row, 11), // Column L (index 11)
                        referee3: data.getFormattedValue(row, 12), // Column M (index 12)
                        commissioner: data.getFormattedValue(row, 55), // Column BD (index 55)
                        scorer1: data.getFormattedValue(row, 13), // Column N (index 13)
                        scorer2: data.getFormattedValue(row, 14), // Column O (index 14)
                        scorer3: data.getFormattedValue(row, 15),  // Column P (index 15)
                        // Add stadium map URLs from columns BE (56) and BF (57)
                        arenaMapUrl1: data.getFormattedValue(row, 56), // Column BE
                        arenaMapUrl2: data.getFormattedValue(row, 57)  // Column BF
                    };
                    gamesByRound[roundForGame].push(gameData);

                    allUniqueTeams.add(gameData.teamA_name);
                    allUniqueTeams.add(gameData.teamB_name);
                }

                // Populate standingsByRound - assumes all standing rows for a given round are grouped together
                // We ensure it's a valid standing entry and not just a header/empty row
                if (roundForStanding !== "" && parseInt(data.getFormattedValue(row, 30)) > 0) { // Check if AE (position) is a valid number
                    if (!standingsByRound[roundForStanding]) {
                        standingsByRound[roundForStanding] = [];
                    }
                    // Create an object for each standing row, using updated column indices
                    const standingData = {
                        round: roundForStanding,
                        position: parseInt(data.getFormattedValue(row, 30)), // AE
                        teamName: data.getFormattedValue(row, 31), // AF
                        points: data.getFormattedValue(row, 34), // AI
                        gamesPlayed: data.getFormattedValue(row, 35), // AJ
                        wins: data.getFormattedValue(row, 38), // AM
                        losses: data.getFormattedValue(row, 39), // AN
                        zeros: data.getFormattedValue(row, 40), // AO
                        pointsFor: data.getFormattedValue(row, 41), // AP
                        pointsAgainst: data.getFormattedValue(row, 42), // AQ
                        defensePoints: data.getFormattedValue(row, 43), // AR (Αμυν) - Renamed from 'difference'
                        overallDifference: data.getFormattedValue(row, 44), // AS (Διαφ - NEW COLUMN)
                        b1_val: data.getFormattedValue(row, 45), // AT (B1 - Shifted by 1)
                        b2_val: data.getFormattedValue(row, 46), // AU (B2 - Shifted by 1)
                        dpIs_val: data.getFormattedValue(row, 47), // AV (ΔΠ ΙΣ - Shifted by 1)
                        keIs_val: data.getFormattedValue(row, 48), // AW (ΚΕ ΙΣ - Shifted by 1)
                        dpOl_val: data.getFormattedValue(row, 49), // AX (ΔΠ ΟΛ - Shifted by 1)
                        keOl_val: data.getFormattedValue(row, 50), // AY (ΚΕ ΟΛ - Shifted by 1)
                        klir_val: data.getFormattedValue(row, 51), // AZ (ΚΛΗΡ - Shifted by 1)
                        progressValue: parseInt(data.getFormattedValue(row, 28)), // AC
                        teamLogoUrl: data.getFormattedValue(row, 52) || DEFAULT_LOGO_URL // BA
                    };
                    standingsByRound[roundForStanding].push(standingData);
                }
            }

            // Sort unique rounds numerically
            uniqueRounds.sort((a, b) => parseInt(a) - parseInt(b));
            sortedUniqueTeams = Array.from(allUniqueTeams).sort();


            var pNameDiorganvtriaArxh = getQueryVariable("pNameDiorganvtriaArxh") ? getQueryVariable("pNameDiorganvtriaArxh") : defaultNameDiorganvtriaArxh;
            var pPowerDiorganvtriaArxh = getQueryVariable("pPowerDiorganvtriaArxh") ? getQueryVariable("pPowerDiorganvtriaArxh") : defaultPowerDiorganvtriaArxh;
            var pAgvnistikhPeriodos = getQueryVariable("pAgvnistikhPeriodos") ? getQueryVariable("pAgvnistikhPeriodos") : defaultAgvnistikhPeriodos;
            var pNamePrvtathlhmatos = getQueryVariable("pNamePrvtathlhmatos") ? getQueryVariable("pNamePrvtathlhmatos") : defaultNamePrvtathlhmatos;
            var pPowerPrvtathlhmatos = getQueryVariable("pPowerPrvtathlhmatos") ? getQueryVariable("pPowerPrvtathlhmatos") : defaultPowerPrvtathlhmatos;
            var pNameKathgoriasOmilou = getQueryVariable("pNameKathgoriasOmilou") ? getQueryVariable("pNameKathgoriasOmilou") : defaultNameKathgoriasOmilou;
            var pPowerKathgoriasOmilou = getQueryVariable("pPowerKathgoriasOmilou") ? getQueryVariable("pPowerKathgoriasOmilou") : defaultPowerKathgoriasOmilou;


            var mainAccordion = document.createElement('div');
            mainAccordion.className = 'accordion';
            mainAccordion.id = 'mainGamesAccordion';

            // Reset firstAccordionToOpen
            firstAccordionToOpen = null; 

            // Function to truncate team names for mobile
            function truncateTeamName(name) {
                // Check if screen width is less than 768px (Bootstrap's md breakpoint)
                if (window.innerWidth < 768) {
                    return name.substring(0, 5); // Return first 5 characters
                }
                return name; // Return full name for larger screens
            }

            uniqueRounds.forEach(function(roundNumber, index) {
                var accordionItemId = `roundAccordionItem_${roundNumber}`;
                var collapseId = `roundCollapse_${roundNumber}`;

                var accordionItem = document.createElement('div');
                accordionItem.className = 'accordion-item';
                accordionItem.id = accordionItemId; // Set ID for easy access during filtering

                var accordionHeader = document.createElement('h2');
                accordionHeader.className = 'accordion-header';
                accordionHeader.id = `heading_${roundNumber}`;

                var accordionButton = document.createElement('button');
                accordionButton.className = 'accordion-button collapsed'; 
                accordionButton.type = 'button';
                accordionButton.setAttribute('data-bs-toggle', 'collapse');
                accordionButton.setAttribute('data-bs-target', `#${collapseId}`);
                accordionButton.setAttribute('aria-expanded', 'false'); 
                accordionButton.setAttribute('aria-controls', collapseId);

                accordionButton.classList.add('d-flex', 'justify-content-between', 'align-items-center');

                const titleDiv = document.createElement('div'); 
                titleDiv.className = 'mb-0 text-dark flex-grow-1'; 
                titleDiv.textContent = `${roundNumber}η Αγωνιστική`;
                accordionButton.appendChild(titleDiv);

                let minGameDate = null;
                let maxGameDate = null;
                let currentRoundGames = gamesByRound[roundNumber] || []; 

                if (currentRoundGames.length > 0) {
                    currentRoundGames.forEach(game => {
                        const [gDay, gMonth, gYear] = game.date.split('/').map(Number);
                        const gameDateObj = new Date(gYear, gMonth - 1, gDay);
                        gameDateObj.setHours(0, 0, 0, 0); 

                        if (!minGameDate || gameDateObj < minGameDate) {
                            minGameDate = gameDateObj;
                        }
                        if (!maxGameDate || gameDateObj > maxGameDate) {
                            maxGameDate = gameDateObj;
                        }
                    });
                }

                const dateDisplayDiv = document.createElement('div'); 
                dateDisplayDiv.classList.add('round-date-display'); 

                // Initialize shouldThisAccordionBeInitiallyOpen to false at the start of each iteration
                let shouldThisAccordionBeInitiallyOpen = false;

                if (minGameDate && maxGameDate) {
                    const isMobileScreen = window.innerWidth < 768;

                    if (minGameDate.toDateString() === maxGameDate.toDateString()) {
                        dateDisplayDiv.textContent = formatFullDateWithDay(minGameDate);
                    } else { 
                        if (isMobileScreen) {
                            dateDisplayDiv.textContent = `${formatSimpleDate(minGameDate)} - ${formatSimpleDate(maxGameDate)}`;
                        } else {
                            dateDisplayDiv.textContent = `Από ${formatSimpleDate(minGameDate)} ως ${formatSimpleDate(maxGameDate)}`;
                        }
                    }

                    // New logic: Prioritize externalRoundParam
                    if (externalRoundParam !== null && roundNumber === externalRoundParam) {
                        shouldThisAccordionBeInitiallyOpen = true;
                    } else if (externalRoundParam === null) {
                        // Fallback to existing date-based logic if no valid external parameter
                        const roundStartsWithinWindow = minGameDate <= fourDaysAfterToday;
                        const roundEndsWithinWindow = fourDaysBeforeToday <= maxGameDate;

                        if (roundStartsWithinWindow && roundEndsWithinWindow) {
                            shouldThisAccordionBeInitiallyOpen = true;
                        }
                    }
                    
                    // Part α: Add class for past rounds
                    if (maxGameDate < today) {
                        accordionButton.classList.add('past-round-accordion');
                    }
                } // End of if (minGameDate && maxGameDate)

                // Apply accordion expansion/collapse based on shouldThisAccordionBeInitiallyOpen
                if (shouldThisAccordionBeInitiallyOpen) {
                    accordionButton.classList.remove('collapsed');
                    accordionButton.setAttribute('aria-expanded', 'true');
                    if (firstAccordionToOpen === null) {
                        firstAccordionToOpen = collapseId; 
                    }
                }
                accordionButton.appendChild(dateDisplayDiv); 
                
                accordionHeader.appendChild(accordionButton);
                accordionItem.appendChild(accordionHeader);

                var accordionCollapse = document.createElement('div');
                accordionCollapse.id = collapseId;
                if (shouldThisAccordionBeInitiallyOpen) { // Use the new flag for initial state
                    accordionCollapse.className = 'accordion-collapse collapse show'; 
                } else {
                    accordionCollapse.className = 'accordion-collapse collapse'; 
                }
                
                accordionCollapse.setAttribute('aria-labelledby', `heading_${roundNumber}`);
                accordionCollapse.setAttribute('data-bs-parent', '#mainGamesAccordion');

                var accordionBody = document.createElement('div');
                accordionBody.className = 'accordion-body p-0'; 

                var navTabs = document.createElement('ul');
                navTabs.className = 'nav nav-tabs nav-justified bg-light pt-2'; 
                navTabs.id = `navTabs_${roundNumber}`;
                navTabs.setAttribute('role', 'tablist');

                var gamesTabLi = document.createElement('li');
                gamesTabLi.className = 'nav-item';
                var gamesNavLink = document.createElement('button');
                gamesNavLink.className = 'nav-link active'; 
                gamesNavLink.id = `games-tab-${roundNumber}`;
                gamesNavLink.setAttribute('data-bs-toggle', 'tab');
                gamesNavLink.setAttribute('data-bs-target', `#games-panel-${roundNumber}`);
                gamesNavLink.setAttribute('type', 'button');
                gamesNavLink.setAttribute('role', 'tab');
                gamesNavLink.setAttribute('aria-controls', `games-panel-${roundNumber}`);
                gamesNavLink.setAttribute('aria-selected', 'true');
                gamesNavLink.textContent = 'Αγώνες';
                gamesTabLi.appendChild(gamesNavLink);
                navTabs.appendChild(gamesTabLi);

                var standingsTabLi = document.createElement('li');
                standingsTabLi.className = 'nav-item';
                var standingsNavLink = document.createElement('button');
                standingsNavLink.className = 'nav-link';
                standingsNavLink.id = `standings-tab-${roundNumber}`;
                standingsNavLink.setAttribute('data-bs-toggle', 'tab');
                standingsNavLink.setAttribute('data-bs-target', `#standings-panel-${roundNumber}`);
                standingsNavLink.setAttribute('type', 'button');
                standingsNavLink.setAttribute('role', 'tab');
                standingsNavLink.setAttribute('aria-controls', `standings-panel-${roundNumber}`);
                standingsNavLink.setAttribute('aria-selected', 'false');
                standingsNavLink.textContent = 'Βαθμολογία';
                standingsTabLi.appendChild(standingsNavLink);
                navTabs.appendChild(standingsTabLi);

                accordionBody.appendChild(navTabs);

                var tabContent = document.createElement('div');
                tabContent.className = 'tab-content';
                tabContent.id = `navTabContent_${roundNumber}`;

                var gamesTabPane = document.createElement('div');
                gamesTabPane.className = 'tab-pane fade show active p-3'; 
                gamesTabPane.id = `games-panel-${roundNumber}`;
                gamesTabPane.setAttribute('role', 'tabpanel');
                gamesTabPane.setAttribute('aria-labelledby', `games-tab-${roundNumber}`);
                
                currentRoundGames = gamesByRound[roundNumber] || []; 
                currentRoundGames.sort((a, b) => {
                    var dateA = new Date(a.date.split('/').reverse().join('-') + 'T' + a.time);
                    var dateB = new Date(b.date.split('/').reverse().join('-') + 'T' + b.time);
                    return dateA - dateB;
                });

                if (currentRoundGames.length > 0) {
                    currentRoundGames.forEach((gameRow, gameIndex) => {
                        var teamA_name_display = truncateTeamName(gameRow.teamA_name);
                        var teamB_name_display = truncateTeamName(gameRow.teamB_name);

                        var teamA_logo = gameRow.teamA_logo;
                        var teamB_logo = gameRow.teamB_logo;
                        var scoreA = gameRow.scoreA;
                        var scoreB = gameRow.scoreB;
                        var arena = gameRow.arena;
                        var date = gameRow.date;
                        var time = gameRow.time;
                        var arenaMapUrl1 = gameRow.arenaMapUrl1; // First map URL
                        var arenaMapUrl2 = gameRow.arenaMapUrl2; // Second map URL

                        var gameDiv = document.createElement('div');
                        // Part β: Changed mb-3 and p-3 to mb-1 and p-1
                        gameDiv.className = 'game-item d-flex flex-md-row align-items-center mb-1 p-1 rounded shadow-sm bg-white'; 
                        // Store full team names as data attributes for filtering
                        gameDiv.dataset.teamA = gameRow.teamA_name;
                        gameDiv.dataset.teamB = gameRow.teamB_name;
                        gameDiv.dataset.gameCode = gameRow.gameCode; // Store gameCode for officials toggle

                        var teamA_div = document.createElement('div');
                        teamA_div.className = 'team-side team-side-left text-start mb-2 mb-md-0 d-flex align-items-center';
                        
                        var logoA_bg_div = document.createElement('div');
                        logoA_bg_div.className = 'team-logo-container team-logo-container-left'; 
                        if (teamA_logo) {
                            logoA_bg_div.style.backgroundImage = `url('${teamA_logo}')`;
                        } else {
                            logoA_bg_div.style.backgroundImage = `url('${DEFAULT_LOGO_URL}')`;
                        }
                        logoA_bg_div.onerror = function() {
                            this.style.backgroundImage = `url('${DEFAULT_LOGO_URL}')`; 
                        };
                        teamA_div.appendChild(logoA_bg_div); 

                        var spanA = document.createElement('span');
                        spanA.className = 'team-name fw-bold';
                        spanA.textContent = teamA_name_display; 
                        teamA_div.appendChild(spanA);
                        gameDiv.appendChild(teamA_div);

                        var center_div = document.createElement('div');
                        center_div.className = 'game-center game-center-fixed text-center mx-md-3 mb-2 mb-md-0 d-flex flex-column justify-content-center align-items-center';

                        var score_div = document.createElement('div');
                        score_div.className = 'game-score d-flex align-items-center justify-content-center';

                        var spanScoreA = document.createElement('span');
                        spanScoreA.className = 'score-number text-primary fw-bold fs-5';
                        spanScoreA.textContent = scoreA;
                        score_div.appendChild(spanScoreA);

                        var spanVersus = document.createElement('span');
                        spanVersus.className = 'versus-text mx-1';
                        spanVersus.textContent = '-';
                        score_div.appendChild(spanVersus);

                        var spanScoreB = document.createElement('span');
                        spanScoreB.className = 'score-number text-primary fw-bold fs-5';
                        spanScoreB.textContent = scoreB;
                        score_div.appendChild(spanScoreB);

                        center_div.appendChild(score_div);

                        // Arena info with map button
                        var info_div = document.createElement('div');
                        info_div.className = 'game-info text-muted small mt-1';
                        
                        // Prioritize arenaMapUrl1, then arenaMapUrl2
                        const currentArenaMapUrl = arenaMapUrl1 || arenaMapUrl2;

                        if (currentArenaMapUrl) {
                            let arenaLink = document.createElement('a');
                            arenaLink.classList.add('MatchListItem__ghpedoButton');
                            arenaLink.href = currentArenaMapUrl;
                            arenaLink.target = '_blank';
                            arenaLink.rel = 'noopener noreferrer';
                            arenaLink.textContent = arena;
                            
                            let externalLinkIcon = document.createElement('span');
                            externalLinkIcon.classList.add('ghpedo-external-link-icon');
                            externalLinkIcon.textContent = ' ↗️';
                            arenaLink.appendChild(externalLinkIcon);
                            info_div.appendChild(arenaLink);
                        } else {
                            let arenaNameSpan = document.createElement('span');
                            arenaNameSpan.classList.add('MatchListItem__ghpedoName');
                            arenaNameSpan.textContent = arena;
                            info_div.appendChild(arenaNameSpan);
                        }
                        
                        info_div.innerHTML += `<br>${date} ${time}`;
                        center_div.appendChild(info_div);
                        
                        // New: Officials Toggle Button (3 dots button)
                        const officialsToggleBtn = document.createElement('button');
                        officialsToggleBtn.className = 'btn btn-sm btn-officials-toggle'; // Use new custom class
                        officialsToggleBtn.type = 'button';
                        officialsToggleBtn.setAttribute('data-bs-toggle', 'collapse');
                        officialsToggleBtn.setAttribute('data-bs-target', `#officials-collapse-${gameRow.gameCode}`);
                        officialsToggleBtn.setAttribute('aria-expanded', 'false');
                        officialsToggleBtn.setAttribute('aria-controls', `officials-collapse-${gameRow.gameCode}`);
                        officialsToggleBtn.innerHTML = '<span>...</span>'; // Three dots
                        center_div.appendChild(officialsToggleBtn);

                        gameDiv.appendChild(center_div);

                        var teamB_div = document.createElement('div');
                        teamB_div.className = 'team-side team-side-right d-flex mb-2 mb-md-0 align-items-center justify-content-end';
                        var spanB = document.createElement('span');
                        spanB.className = 'team-name fw-bold';
                        spanB.textContent = teamB_name_display; 
                        teamB_div.appendChild(spanB);

                        var logoB_bg_div = document.createElement('div');
                        logoB_bg_div.className = 'team-logo-container team-logo-container-right';
                        if (teamB_logo) {
                            logoB_bg_div.style.backgroundImage = `url('${teamB_logo}')`;
                        } else {
                            logoB_bg_div.style.backgroundImage = `url('${DEFAULT_LOGO_URL}')`;
                        }
                        logoB_bg_div.onerror = function() {
                            this.style.backgroundImage = `url('${DEFAULT_LOGO_URL}')`; 
                        };
                        teamB_div.appendChild(logoB_bg_div); 
                        
                        gameDiv.appendChild(teamB_div);

                        gamesTabPane.appendChild(gameDiv);

                        // New: Officials Accordion Collapse below each game item
                        const officialsCollapse = document.createElement('div');
                        officialsCollapse.id = `officials-collapse-${gameRow.gameCode}`;
                        officialsCollapse.className = 'collapse officials-info-collapse'; // Custom class for styling
                        officialsCollapse.setAttribute('data-bs-parent', `#games-panel-${roundNumber}`); // Ensure it collapses within the tab pane

                        const officialsCardBody = document.createElement('div');
                        officialsCardBody.className = 'card card-body officials-card-body';

                        const officialsList = document.createElement('ul');
                        officialsList.className = 'list-unstyled small text-muted text-start mb-0';

                        // Helper function to add official if available and not empty/whitespace
                        const addOfficialToList = (label, value) => {
                            if (value && value.trim() !== "") {
                                const listItem = document.createElement('li');
                                listItem.innerHTML = `<strong>${label}:</strong> ${value}`;
                                officialsList.appendChild(listItem);
                            }
                        };
                        
                        // Add officials based on provided data, only if not empty
                        addOfficialToList('Διαιτητής 1', gameRow.referee1);
                        addOfficialToList('Διαιτητής 2', gameRow.referee2);
                        addOfficialToList('Διαιτητής 3', gameRow.referee3); 
                        addOfficialToList('Κομισάριος', gameRow.commissioner);
                        addOfficialToList('Κριτής 1', gameRow.scorer1);
                        addOfficialToList('Κριτής 2', gameRow.scorer2);
                        addOfficialToList('Κριτής 3', gameRow.scorer3);

                        // Changed default message
                        if (officialsList.children.length === 0) {
                            const noOfficialsItem = document.createElement('li');
                            noOfficialsItem.textContent = 'Δεν έχουμε ορισμούς για τον αγώνα.';
                            officialsList.appendChild(noOfficialsItem);
                        }

                        officialsCardBody.appendChild(officialsList);
                        officialsCollapse.appendChild(officialsCardBody);
                        gamesTabPane.appendChild(officialsCollapse); // Append after the gameDiv
                    });
                } else {
                    var noGamesDiv = document.createElement('div');
                    noGamesDiv.className = 'alert alert-info text-center';
                    noGamesDiv.textContent = 'Δεν βρέθηκαν αγώνες για αυτή την αγωνιστική.';
                    gamesTabPane.appendChild(noGamesDiv);
                }

                tabContent.appendChild(gamesTabPane);

                var standingsTabPane = document.createElement('div');
                standingsTabPane.className = 'tab-pane fade p-3'; 
                standingsTabPane.id = `standings-panel-${roundNumber}`;
                standingsTabPane.setAttribute('role', 'tabpanel');
                standingsTabPane.setAttribute('aria-labelledby', `standings-tab-${roundNumber}`);

                let currentRoundStandings = standingsByRound[roundNumber] || []; 
                if (currentRoundStandings.length > 0) {
                    var standingsTable = document.createElement('table');
                    standingsTable.className = 'table table-hover table-striped table-sm standings-table'; 

                    var thead = document.createElement('thead');
                    var headerRow = document.createElement('tr');
                    const standingsHeaders = [
                        { text: 'Θ', property: 'position', class: '' },
                        { text: ' ', property: 'teamLogoUrl', class: '' },
                        { text: 'Ομάδες', property: 'teamName', class: 'text-start' },
                        { text: 'Βαθ', property: 'points', class: 'fw-bold' },
                        { text: 'Αγών', property: 'gamesPlayed', class: '' },
                        { text: 'Nικ', property: 'wins', class: 'd-none d-md-table-cell' },
                        { text: 'Ηττ', property: 'losses', class: 'd-none d-md-table-cell' },
                        { text: 'Μ', property: 'zeros', class: 'd-none d-md-table-cell' },
                        { text: 'ΑΦ', property: 'pointsFor', class: 'd-none d-md-table-cell' },
                        { text: 'Επίθ', property: 'pointsAgainst', class: 'd-none d-md-table-cell' },
                        { text: 'Αμυν', property: 'defensePoints', class: 'd-none d-md-table-cell' },
                        { text: 'Διαφ', property: 'overallDifference', class: 'd-none d-md-table-cell' },
                        { text: 'B1', property: 'b1_val', class: '' },
                        { text: 'B2', property: 'b2_val', class: '' },
                        { text: 'ΔΠ ΙΣ', property: 'dpIs_val', class: 'd-none d-md-table-cell' },
                        { text: 'ΚΕ ΙΣ', property: 'keIs_val', class: 'd-none d-md-table-cell' },
                        { text: 'ΔΠ ΟΛ', property: 'dpOl_val', class: 'd-none d-md-table-cell' },
                        { text: 'ΚΕ ΟΛ', property: 'keOl_val', class: 'd-none d-md-table-cell' },
                        { text: 'ΚΛΗΡ', property: 'klir_val', class: 'd-none d-md-table-cell' },
                        { text: 'Πρόοδος', property: 'progressValue', class: 'd-none d-md-table-cell' }
                    ];

                    standingsHeaders.forEach(headerInfo => {
                        var th = document.createElement('th');
                        th.scope = 'col';
                        th.textContent = headerInfo.text;
                        if (headerInfo.class) {
                            th.classList.add(...headerInfo.class.split(' '));
                        }
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
                    standingsTable.appendChild(thead);

                    var tbody = document.createElement('tbody');
                    currentRoundStandings.forEach((standingRow, standingIndex) => {
                        var tr = document.createElement('tr');
                        
                        // Apply promotion/relegation classes only if the values are valid numbers
                        if (promotionPositions !== null && standingRow.position <= promotionPositions) {
                            tr.classList.add('table-success-light');
                        }
                        if (relegationStartFrom !== null && standingRow.position >= relegationStartFrom) {
                            tr.classList.add('table-danger-light');
                        }

                        if (promotionPositions !== null && standingRow.position === promotionPositions) {
                            tr.classList.add('promotion-border-bottom');
                        }
                        if (relegationStartFrom !== null && standingRow.position === relegationStartFrom) {
                            tr.classList.add('relegation-border-top');
                        }
                        
                        standingsHeaders.forEach(headerInfo => {
                            var td = document.createElement('td');
                            let cellValue = standingRow[headerInfo.property]; 

                            switch (headerInfo.property) {
                                case 'teamLogoUrl':
                                    var logoDiv = document.createElement('div');
                                    logoDiv.className = 'team-logo-bg';
                                    if (cellValue) { 
                                        const dummyImg = new Image();
                                        dummyImg.src = cellValue;
                                        dummyImg.onerror = function() {
                                            logoDiv.style.backgroundImage = 'none';
                                            logoDiv.classList.add('team-logo-placeholder');
                                        };
                                        logoDiv.style.backgroundImage = `url('${cellValue}')`;
                                    }
                                    td.appendChild(logoDiv); 
                                    break;
                                case 'teamName':
                                    td.classList.add('fw-bold', 'text-start'); 
                                    td.textContent = cellValue;
                                    break;
                                case 'points':
                                    td.classList.add('standings-points', 'fw-bold');
                                    td.textContent = cellValue;
                                    break;
                                case 'progressValue': 
                                    let progressHtml = '';
                                    let progressClasses = [];
                                    if (cellValue > 0) {
                                        progressHtml = `▲ ${cellValue}`;
                                        progressClasses.push('text-success', 'fw-bold');
                                    } else if (cellValue < 0) {
                                        progressHtml = `▼ ${Math.abs(cellValue)}`;
                                        progressClasses.push('text-danger', 'fw-bold');
                                    } else {
                                        progressHtml = `—`;
                                        progressClasses.push('text-muted');
                                    }
                                    td.innerHTML = progressHtml;
                                    td.classList.add(...progressClasses);
                                    break;
                                default: 
                                    if (cellValue === '' || cellValue === '0') {
                                        td.classList.add('hide-empty-value'); 
                                    } else {
                                        td.textContent = cellValue; 
                                    }
                                    break;
                            }
                            
                            if (headerInfo.class) {
                                td.classList.add(...headerInfo.class.split(' '));
                            }
                            
                            tr.appendChild(td);
                        });
                        tbody.appendChild(tr);
                    });
                    standingsTable.appendChild(tbody);
                    standingsTabPane.appendChild(standingsTable);
                } else {
                    var noStandingsDiv = document.createElement('div');
                    noStandingsDiv.className = 'alert alert-info text-center';
                    noStandingsDiv.textContent = 'Δεν βρέθηκε βαθμολογία για αυτή την αγωνιστική.';
                    standingsTabPane.appendChild(noStandingsDiv);
                }

                tabContent.appendChild(standingsTabPane);
                accordionBody.appendChild(tabContent);
                accordionCollapse.appendChild(accordionBody);
                accordionItem.appendChild(accordionCollapse);
                mainAccordion.appendChild(accordionItem);
            });
            contentDiv.appendChild(mainAccordion);

            // Setup filters and apply them
            setupFilters();

            // --- Start of dynamically added footer content (replacing static footer) ---
            // Add the footer buttons container
            const footerButtonsContainer = document.createElement('div');
            footerButtonsContainer.classList.add('col-12', 'text-center', 'mt-4', 'mb-2', 'd-flex', 'justify-content-center', 'gap-3');

            // Add "Πίσω" button
            /* ----             
            /* ---- για να μην εχει πολλες οχλησεις---
            /* ---- 

            const backLink = document.createElement('a');
            backLink.href = 'mc_02_Kathgories.html' + // Link back to categories
                '?pNameDiorganvtriaArxh=' + encodeURIComponent(getQueryVariable("pNameDiorganvtriaArxh")) +
                '&pPowerDiorganvtriaArxh=' + encodeURIComponent(getQueryVariable("pPowerDiorganvtriaArxh")) +
                '&pAgvnistikhPeriodos=' + encodeURIComponent(getQueryVariable("pAgvnistikhPeriodos")) +
                '&pNamePrvtathlhmatos=' + encodeURIComponent(getQueryVariable("pNamePrvtathlhmatos")) +
                '&pPowerPrvtathlhmatos=' + encodeURIComponent(getQueryVariable("pPowerPrvtathlhmatos"));
            backLink.classList.add('btn', 'btn-sm', 'btn-back-custom');
            backLink.textContent = '← Πίσω';
            footerButtonsContainer.appendChild(backLink);

           ----  */

            // Add "Προκηρύξεις" button
            const announcementsLink = document.createElement('a');
            announcementsLink.href = 'https://www.ekasth1976.gr/2024/07/2024-25.html';
            announcementsLink.target = '_blank';
            announcementsLink.classList.add('btn', 'btn-sm', 'btn-back-custom');
            announcementsLink.textContent = 'Προκηρύξεις';
            footerButtonsContainer.appendChild(announcementsLink);
            
            contentDiv.appendChild(footerButtonsContainer);

            // Add the footer elements as per user's request
            const ekasthDiv = document.createElement('div');
            ekasthDiv.classList.add('ekasth-footer-text', 'text-center', 'mt-3', 'mb-0', 'col-12');
            const now = new Date();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const year = now.getFullYear();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const formattedDateTime = `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
            ekasthDiv.textContent = `Ε.ΚΑ.Σ.Θ. 1976 - ${formattedDateTime}`;
            contentDiv.appendChild(ekasthDiv);

            const versionDiv = document.createElement('div');
            versionDiv.classList.add('ekasth-footer-version-text', 'text-center', 'mt-0', 'mb-0', 'col-12');
            versionDiv.textContent = `LT v.25.06.18 | mc_03_programma-agvnvn-apotelesmata-bathmologia @ myekasth`; 
            contentDiv.appendChild(versionDiv);
            // --- End of dynamically added footer content ---
        }

        /**
         * Populates the round and team filter dropdowns.
         */
        function setupFilters() {
            const roundFilter = document.getElementById('roundFilter');
            const teamFilter = document.getElementById('teamFilter');

            // Populate Round Filter
            roundFilter.innerHTML = `
                <option value="current">Τρέχουσα Αγωνιστική (±4 ημ)</option>
                <option value="all">Όλες οι Αγωνιστικές</option>
            `;
            uniqueRounds.forEach(round => {
                const option = document.createElement('option');
                option.value = round;
                option.textContent = `${round}η Αγωνιστική`;
                roundFilter.appendChild(option);
            });

            // Set the selected value for the round filter based on externalRoundParam or default
            if (externalRoundParam && uniqueRounds.includes(externalRoundParam)) {
                roundFilter.value = externalRoundParam;
            } else {
                roundFilter.value = 'current'; // Default if no valid external param
            }


            // Populate Team Filter
            teamFilter.innerHTML = '<option value="all">Όλες οι Ομάδες</option>';
            sortedUniqueTeams.forEach(teamName => {
                const option = document.createElement('option');
                option.value = teamName;
                option.textContent = teamName;
                teamFilter.appendChild(option);
            });

            // Add event listeners
            roundFilter.addEventListener('change', applyFilters);
            teamFilter.addEventListener('change', applyFilters);

            // Apply filters initially to set default state and scroll
            // Pass null as event to indicate initial load
            applyFilters(null);
        }

        /**
         * Applies the selected filters to the displayed games and accordions.
         * @param {Event | null} event The event object from the dropdown change, or null for initial load.
         */
        function applyFilters(event) {
            let selectedRoundElement = document.getElementById('roundFilter');
            let selectedTeamElement = document.getElementById('teamFilter');

            let selectedRound = selectedRoundElement.value;
            let selectedTeam = selectedTeamElement.value;
            
            // Determine which filter triggered the call
            let filterTriggered = null;
            if (event && event.target) {
                filterTriggered = event.target.id === 'roundFilter' ? 'round' : 'team';
            } else {
                // Initial load: default to round filter logic
                filterTriggered = 'round';
            }

            if (filterTriggered === 'team') {
                // If team filter was changed, reset round filter to "all"
                selectedRoundElement.value = 'all'; 
                selectedRound = 'all'; // Update local variable for logic
                // The selectedTeam value is already set by the user's action
            } else { // filterTriggered === 'round' (or initial load)
                // If round filter was changed, reset team filter to "all"
                selectedTeamElement.value = 'all'; 
                selectedTeam = 'all'; // Update local variable for logic
                // The selectedRound value is already set by the user's action
            }


            const accordions = document.querySelectorAll('#mainGamesAccordion .accordion-item');
            let firstAccordionToScroll = null;

            accordions.forEach(accordionItem => {
                const roundNumber = accordionItem.id.replace('roundAccordionItem_', '');
                const accordionButton = accordionItem.querySelector('.accordion-button');
                const accordionCollapse = accordionItem.querySelector('.accordion-collapse');
                const gamesTabPane = accordionItem.querySelector(`#games-panel-${roundNumber}`);
                const navTabs = accordionItem.querySelector('.nav-tabs'); 

                let shouldAccordionBeExpanded = false; 
                let shouldGameBeFilteredByTeam = false; 

                // Logic for accordion expansion based on the *currently active* filter mode (after potential resets)
                if (selectedTeam !== 'all') { // If a specific team is selected (team filter is active)
                    shouldAccordionBeExpanded = true;
                    shouldGameBeFilteredByTeam = true; // Games are filtered by team
                    if (navTabs) { navTabs.classList.add('d-none'); } // Hide nav-tabs

                    // Part β: Ensure "Αγώνες" tab is selected for this round when team filter is active
                    const gamesNavLink = accordionItem.querySelector(`#games-tab-${roundNumber}`);
                    const standingsNavLink = accordionItem.querySelector(`#standings-tab-${roundNumber}`);
                    if (standingsNavLink && standingsNavLink.classList.contains('active')) {
                        const gamesTab = new bootstrap.Tab(gamesNavLink);
                        gamesTab.show();
                    }

                } else { // If no specific team is selected (round filter is active or default)
                    if (selectedRound === 'all') {
                        shouldAccordionBeExpanded = true;
                    } else if (selectedRound === 'current') {
                        let minGameDate = null;
                        let maxGameDate = null;
                        let currentRoundGamesForDateCheck = gamesByRound[roundNumber] || []; 

                        if (currentRoundGamesForDateCheck.length > 0) {
                            currentRoundGamesForDateCheck.forEach(game => {
                                const [gDay, gMonth, gYear] = game.date.split('/').map(Number);
                                const gameDateObj = new Date(gYear, gMonth - 1, gDay);
                                gameDateObj.setHours(0, 0, 0, 0);

                                if (!minGameDate || gameDateObj < minGameDate) {
                                    minGameDate = gameDateObj;
                                }
                                if (!maxGameDate || gameDateObj > maxGameDate) {
                                    maxGameDate = gameDateObj;
                                }
                            });
                        }

                        if (minGameDate && maxGameDate) {
                            const roundStartsWithinWindow = minGameDate <= fourDaysAfterToday;
                            const roundEndsWithinWindow = fourDaysBeforeToday <= maxGameDate;
                            if (roundStartsWithinWindow && roundEndsWithinWindow) {
                                shouldAccordionBeExpanded = true;
                            }
                        }
                    } else { 
                        if (roundNumber === selectedRound) {
                            shouldAccordionBeExpanded = true;
                        }
                    }
                    shouldGameBeFilteredByTeam = false; // Games are NOT filtered by team
                    if (navTabs) { navTabs.classList.remove('d-none'); } // Show nav-tabs
                }

                // Apply accordion expansion/collapse
                if (shouldAccordionBeExpanded) {
                    accordionButton.classList.remove('collapsed');
                    accordionButton.setAttribute('aria-expanded', 'true');
                    accordionCollapse.classList.add('show');
                    if (firstAccordionToScroll === null) { 
                        firstAccordionToScroll = accordionCollapse.id;
                    }
                } else {
                    accordionButton.classList.add('collapsed');
                    accordionButton.setAttribute('aria-expanded', 'false');
                    accordionCollapse.classList.remove('show');
                }

                // Apply game visibility logic
                const gameItems = gamesTabPane.querySelectorAll('.game-item');
                gameItems.forEach(gameItem => {
                    const teamA_name_full = gameItem.dataset.teamA; 
                    const teamB_name_full = gameItem.dataset.teamB; 
                    const officialsCollapseDiv = document.getElementById(`officials-collapse-${gameItem.dataset.gameCode}`);

                    if (shouldGameBeFilteredByTeam) {
                        if (teamA_name_full.includes(selectedTeam) || teamB_name_full.includes(selectedTeam)) {
                            gameItem.classList.remove('d-none'); 
                            gameItem.classList.add('d-flex'); 
                            // Also ensure the officials toggle button is visible when filtering by team and game is visible
                            const officialsToggle = gameItem.querySelector('.btn-officials-toggle');
                            if (officialsToggle) officialsToggle.classList.remove('d-none');
                        } else {
                            gameItem.classList.add('d-none'); 
                            gameItem.classList.remove('d-flex'); 
                            // Hide officials toggle button if game is hidden
                            const officialsToggle = gameItem.querySelector('.btn-officials-toggle');
                            if (officialsToggle) officialsToggle.classList.add('d-none');
                            // Ensure any open officials accordion is closed if the game is hidden
                            if (officialsCollapseDiv && officialsCollapseDiv.classList.contains('show')) {
                                officialsCollapseDiv.classList.remove('show');
                            }
                        }
                    } else { // Show all games within the expanded accordions (no team filter active)
                        gameItem.classList.remove('d-none'); 
                        gameItem.classList.add('d-flex'); 
                        // Always show officials toggle button when not filtering by team
                        const officialsToggle = gameItem.querySelector('.btn-officials-toggle');
                        if (officialsToggle) officialsToggle.classList.remove('d-none');
                    }
                });
            });

            // Scroll to the first expanded accordion, if any
            if (firstAccordionToScroll) {
                setTimeout(() => {
                    const element = document.getElementById(firstAccordionToScroll);
                    if (element) {
                        element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100); 
            }
        }
    </script>

    <style>
        /* CSS variables for consistent theming */
        :root {
            --mc-primary-color: #007bff; /* Bootstrap primary blue */
            --mc-secondary-color: #6c757d; /* Bootstrap secondary gray */
            --mc-info-color: #17a2b8; /* Bootstrap info cyan */
            --mc-light-bg: #f8f9fa; /* Light background */
            --mc-dark-bg: #212529; /* Dark text for contrast */
            --mc-text-dark: #212529; /* Dark text for light backgrounds */
            --mc-timeline-color: #ff0000; /* Pure red for underline */

            /* Monochromatic white header colors and contrasting text colors */
            --mc-header-bg-color: #ffffff; /* Pure white background for header */
            --mc-header-text-color: #212529; /* Dark text for contrast on white */
            --mc-header-small-text-color: #6c757d; /* Secondary gray for smaller text */
            --mc-header-combined-title-color: #343a40; /* Darker gray for combined title */

            --mc-filter-bg-color: #e0e0e0; /* Light gray for filter zone background */
        }

        /* Base body styling */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--mc-light-bg);
            color: var(--mc-text-dark);
            padding-top: 0; /* No fixed top padding as header is sticky */
        }

        /* Font styling for headings */
        h1, h5 {
            font-family: 'Krona One', sans-serif;
        }

        /* New Sticky Header Tabs */
        .sticky-header-tabs {
            position: sticky;
            top: 0;
            width: 100%;
            background: var(--mc-header-bg-color);
            box-shadow: 0 2px 8px rgba(0,0,0,.1);
            z-index: 1020;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .MatchcenterHomepageWidget__header {
            font-family: 'Krona One', sans-serif;
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--mc-header-text-color);
        }

        .MatchcenterHomepageWidget__header small {
            font-size: 0.6em;
            vertical-align: middle;
            color: var(--mc-header-small-text-color);
            font-weight: 300;
        }

                /* New styles for the custom superscript */
        .MatchcenterHomepageWidget__header .header-superscript {
            font-size: 0.5em; /* Half the size of the parent header font */
            vertical-align: super;
            line-height: 0; /* Adjust line height to prevent affecting vertical spacing */
            position: relative;
            top: -0.5em; /* Fine-tune vertical position */
        }

        .header-underline {
            height: 5px;
            width: 100%;
            background-color: var(--mc-timeline-color);
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

        .combined-header-title {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 0;
            color: var(--mc-header-combined-title-color);
            text-align: center;
        }

        /* Filter Zone Styling */
        .filter-zone {
            background-color: var(--mc-filter-bg-color);
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Space between filter elements */
            align-items: center;
            justify-content: center;
        }

        .filter-zone .form-select {
            max-width: 300px; /* Limit width of dropdowns */
            min-width: 180px; /* Ensure a minimum width */
            flex-grow: 1; /* Allow them to grow */
        }
        
        .filter-zone label {
            margin-bottom: 0.25rem;
            font-weight: 500;
            color: var(--mc-text-dark);
        }
        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }


        /* Accordion specific styles */
        .accordion-item {
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.03);
            /* Part α: Changed margin-bottom */
            margin-bottom: 0.3rem;
            border: none;
            overflow: hidden;
        }

        .accordion-button {
            background-color: #e9ecef;
            color: var(--mc-text-dark);
            font-weight: 600;
            border-radius: 0.75rem !important;
            padding: 1rem 1.25rem;
            transition: background-color 0.2s ease;
        }

        .accordion-button:not(.collapsed) {
            background-color: var(--mc-primary-color);
            color: #ffffff; /* White text when active */
            box-shadow: inset 0 -1px 0 rgba(0,0,0,.125);
        }
        /* Style for past rounds */
        .past-round-accordion {
            background-color: #d8d8d8 !important; /* Darker grey for past rounds */
            color: #495057 !important; /* Darker text */
        }
        .past-round-accordion:not(.collapsed) {
            background-color: #a0a0a0 !important; /* Even darker grey when active/expanded */
            color: #ffffff !important;
        }

        .accordion-button h5 { 
            color: inherit; 
            margin-bottom: 0;
        }

        .accordion-button:focus {
            box-shadow: none;
        }

        .accordion-body {
            padding: 0; 
            background-color: #f8f9fa;
            border-top: 1px solid rgba(0,0,0,.05);
        }

        /* Styles for the navigation tabs */
        .nav-tabs {
            border-bottom: 1px solid rgba(0,0,0,.05);
            margin-bottom: 0; 
        }

        .nav-tabs .nav-link {
            border: none;
            border-radius: 0.5rem 0.5rem 0 0;
            color: var(--mc-secondary-color);
            font-weight: 500;
            background-color: transparent;
            padding: 0.75rem 1rem;
            margin-bottom: -1px; 
            transition: all 0.2s ease;
        }

        .nav-tabs .nav-link.active {
            color: var(--mc-primary-color);
            background-color: #ffffff;
            border-bottom: 3px solid var(--mc-primary-color); 
            font-weight: 700;
        }
        .nav-tabs .nav-link:hover {
            color: var(--mc-primary-color);
        }

        .tab-content {
            border-top: none;
            background-color: #ffffff; 
            border-radius: 0 0 0.75rem 0.75rem; 
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.02); 
        }

        .tab-pane {
            padding: 1.5rem; 
        }

        /* Game item styling */
        .game-item {
            border: 1px solid #e0e0e0;
            box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,.02);
            transition: all 0.2s ease-in-out;
            background-color: #ffffff !important;
            flex-wrap: nowrap; 
            justify-content: center; 
            position: relative; /* For positioning the officials toggle button */
        }
        .game-item:hover {
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,.08);
            transform: translateY(-2px);
            background-color: #f5f5f5 !important; 
        }

        .team-side-left, .team-side-right {
            flex-basis: 40%;
            flex-grow: 0;
            flex-shrink: 0;
            padding: 0 1rem; 
        }

        .game-center-fixed {
            flex-basis: 20%;
            flex-grow: 0;
            flex-shrink: 0;
            align-items: center !important;
            justify-content: center !important;
        }

        .team-logo-container {
            width: 50px; 
            height: 50px; 
            background-size: contain; 
            background-repeat: no-repeat;
            display: flex; 
            align-items: center; 
        }

        .team-logo-container-left {
            background-position: center left; 
            margin-right: 0.5rem; 
        }

        .team-logo-container-right {
            background-position: center right; 
            margin-left: 0; 
        }
        
        .score-logos-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; 
        }

        .team-score-logo {
            display: flex;
            align-items: center;
        }

        .score-number {
            font-family: 'Krona One', sans-serif;
            font-size: 1.95rem !important; 
        }
        .versus-text {
            font-size: 1.5rem; 
            font-weight: bold;
        }
        .game-info {
            font-size: 0.85rem;
            color: var(--mc-secondary-color);
        }

        .round-date-display {
            font-size: 0.85em; 
            color: inherit; 
            white-space: nowrap; 
            text-align: right; 
        }

        /* Officials Toggle Button (new styling) */
        .btn-officials-toggle {
            background-color: transparent; /* Same as btn-back-custom */
            /* Part γ: Changed color */
            color: rgba(33, 37, 41, 0.2);
            /* Part γ: Changed border */
            border: 1px solid rgba(33, 37, 41, 0.3);
            transition: all 0.3s ease; /* Smooth transition for hover effects */
            padding: 0.1rem 0.6rem; /* Smaller padding for minimal height */
            border-radius: 0.5rem; /* Standard border-radius */
            /* Part γ: Changed font-size */
            font-size: 0.6rem;
            line-height: 1; /* Minimal height by adjusting line-height */
            text-decoration: none; /* No underline */
            position: absolute; /* Position relative to .game-item */
            bottom: 0; /* Align to the bottom of game-item */
            left: 50%; /* Center horizontally */
            transform: translateX(-50%) translateY(50%); /* Adjust to center it properly below the div */
            z-index: 10; /* Ensure it's clickable */
            display: inline-flex; /* Use flexbox to center content */
            align-items: center;
            justify-content: center;
        }
        .btn-officials-toggle:hover {
            background-color: rgba(33, 37, 41, 0.1); /* Light transparent dark grey on hover */
            color: var(--mc-header-text-color); /* Full dark text on hover */
            border-color: var(--mc-header-text-color); /* Visible dark border on hover */
        }
        .btn-officials-toggle:not(.collapsed) {
            color: var(--mc-primary-color);
            background-color: rgba(0, 123, 255, 0.1); /* Light blue background when expanded */
        }

        /* Officials Info Collapse styles */
        .officials-info-collapse {
            width: 100%;
            background-color: #f0f0f0; /* Light background for officials info */
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 0.75rem 0.75rem;
            margin-top: 0.75rem; /* Space from the game item */
            box-shadow: inset 0 2px 4px rgba(0,0,0,.03);
            text-align: left;
        }
        .officials-card-body {
            padding: 0.75rem 1.5rem;
            background-color: transparent !important;
            border: none !important;
        }
        .officials-card-body ul {
            list-style: none; /* Remove bullet points */
            padding-left: 0;
            margin-bottom: 0;
        }
        .officials-card-body ul li {
            padding: 0.2em 0;
        }
        .officials-card-body ul li strong {
            color: var(--mc-text-dark); /* Make labels slightly darker */
        }

        /* Styling for the new arena map button */
        .MatchListItem__ghpedoButton {
            display: inline-flex; /* To align text and icon */
            align-items: center; /* Vertically center content */
            padding: 3px 8px; /* Small padding for button-like appearance */
            font-size: 0.7em; /* Smaller font size */
            font-weight: 500;
            letter-spacing: 0.05em;
            background-color: transparent; /* Transparent background for a subtle look */
            border: 1px solid rgba(0,0,0,0.1); /* Light border */
            border-radius: 4px;
            text-decoration: none; /* Remove underline */
            color: #003e5e; /* Text color */
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .MatchListItem__ghpedoButton:hover {
            background-color: #e2e4e6; /* Slightly darker on hover */
            border-color: #d0d0d0;
            cursor: pointer;
        }

        .ghpedo-external-link-icon {
            margin-left: 5px; /* Space between text and icon */
            font-size: 0.8em; /* Smaller icon */
            line-height: 1;
            vertical-align: middle;
            color: #666;
        }

        .MatchListItem__ghpedoName {
            font-size: 0.7em; /* Original font size if no URL */
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        /* Standings Table Styling */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        /* Part δ: Changed padding */
        .standings-table th, .standings-table td {
            padding: 0.3rem 0.3rem;
            text-align: center;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }

        .standings-table thead th {
            background-color: #e9ecef;
            font-weight: 600;
            color: var(--mc-text-dark);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .standings-table tbody tr:last-child td {
            border-bottom: none;
        }

        .standings-table tbody tr:hover {
            background-color: #f5f5f5;
        }

        .standings-table .standings-points {
            font-size: 1.1rem;
            font-weight: bold;
            color: var(--mc-primary-color);
        }
        .standings-table .text-start {
            text-align: left !important;
        }

        .standings-table .team-logo-bg {
            width: 30px;
            height: 30px;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            display: inline-block;
            vertical-align: middle;
            margin-right: 5px;
        }

        /* Promotion/Relegation colors */
        .table-success-light {
            background-color: #d4edda !important;
        }
        .table-danger-light {
            background-color: #f8d7da !important;
        }
        .promotion-border-bottom {
            border-bottom: 3px solid #28a745 !important;
        }
        .relegation-border-top {
            border-top: 3px solid #dc3545 !important;
        }

        /* Hide cell content for empty values (keep cell background) */
        .hide-empty-value {
            color: transparent;
        }

        /* Footer styles */
        .ekasth-footer-text, .ekasth-footer-version-text {
            font-size: 0.55rem;
            color: var(--mc-secondary-color);
            padding: 0.1rem 0;
        }

        .ekasth-footer-text {
            border-top: 1px solid rgba(0,0,0,.1);
            padding-top: 1.5rem;
        }

        .btn-back-custom {
            background-color: transparent;
            color: rgba(33, 37, 41, 0.5);
            border: 1px solid rgba(33, 37, 41, 0.2);
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.85rem;
            text-decoration: none;
        }

        .btn-back-custom:hover,
        .btn-back-custom:focus {
            background-color: rgba(33, 37, 41, 0.1);
            color: var(--mc-header-text-color);
            border-color: var(--mc-header-text-color);
            box-shadow: none;
        }

        /* Responsive adjustments for smaller screens */
        @media (max-width: 767.98px) {
            .sticky-header-tabs {
                padding-left: 1rem;
            }
            .MatchcenterHomepageWidget__header {
                font-size: 2.2rem;
            }
            .combined-header-title {
                font-size: 1.1rem;
            }
            /* Hide columns in standings table on small screens */
            .standings-table th.d-md-table-cell,
            .standings-table td.d-md-table-cell {
                display: none !important;
            }
            /* Adjust padding for tab panes on small screens */
            .tab-pane {
                padding: 1rem 0.5rem;
            }
            .game-item {
                align-items: center !important; 
                flex-wrap: nowrap; 
            }
            .team-side-left, .team-side-right {
                flex-basis: 40%;
                flex-grow: 0;
                flex-shrink: 0;
                padding: 0 0.5rem; 
            }
            .game-center-fixed {
                flex-basis: 20%;
                flex-grow: 0;
                flex-shrink: 0;
                padding: 0 0.5rem; 
            }

            .team-logo-container {
                 display: flex !important; 
                 width: 40px !important; 
                 height: 40px !important; 
            }
            
            .game-center-fixed .score-logos-container {
                justify-content: center !important;
            }

            .game-center {
                margin-top: 0.5rem;
                margin-bottom: 0.5rem;
            }

            .round-date-display {
                font-size: calc(0.85em - 2px); 
            }

            .filter-zone {
                flex-direction: column; /* Stack filters vertically on small screens */
                align-items: stretch; /* Stretch to fill width */
            }
            .filter-group {
                width: 100%; /* Full width for each filter group */
            }
            /* Adjust officials toggle button for mobile */
            .btn-officials-toggle {
                position: static; /* Remove absolute positioning */
                transform: none; /* Remove transform */
                margin-top: 0.5rem; /* Add some space */
            }
            .officials-info-collapse {
                margin-top: 0.5rem; /* Reduce top margin on mobile */
            }
        }
    </style>
</head>

<body id="myPage">

    <!-- Sticky Header Tabs -->
    <div class="sticky-header-tabs">
        <div class="header-pre-title">Ε.ΚΑ.Σ.Θ.</div>
        <h3 class="MatchcenterHomepageWidget__header">
            MATCHCENTER<span class="header-superscript">4</span>
        </h3>
        <div class="header-underline"></div>
        <div class="combined-header-title" id="combined-header-title">
            ΠΡΟΓΡΑΜΜΑ & ΒΑΘΜΟΛΟΓΙΕΣ
        </div>
    </div>

    <!-- Filter Zone -->
    <section class="container my-2">
        <div class="filter-zone">
            <div class="filter-group">
                <label for="roundFilter" class="form-label">Φιλτράρισμα ανά Αγωνιστική:</label>
                <select id="roundFilter" class="form-select"></select>
            </div>
            <div class="filter-group">
                <label for="teamFilter" class="form-label">Φιλτράρισμα ανά Ομάδα:</label>
                <select id="teamFilter" class="form-select"></select>
            </div>
        </div>
    </section>

    <!-- Main content section for displaying games and standings -->
    <section class="container my-2">
        <div class="row" id="list-content-id">
            <!-- Loading spinner displayed until data is fetched -->
            <div class="col-12 text-center" id="loading-spinner">
                <div class="progress">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="100" aria-valuemin="0" aria-valuemax="100" style="width: 100%"></div>
                </div>
                <p>Φόρτωση δεδομένων ...</p>
            </div>
            <!-- Content will be injected here by JavaScript -->
        </div>
    </section>


</body>
</html>
